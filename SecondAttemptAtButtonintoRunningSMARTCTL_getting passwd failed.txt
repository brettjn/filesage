# python
# file: `filesage/main_window.py`
import os
import shutil
import signal
import subprocess
from typing import Set

from PySide6.QtWidgets import (
    QMainWindow,
    QTabWidget,
    QWidget,
    QVBoxLayout,
    QLabel,
    QPlainTextEdit,
    QPushButton,
)
from PySide6.QtGui import QGuiApplication
from PySide6.QtCore import QTimer, QCoreApplication, QThread, Signal


class SmartctlWorker(QThread):
    finished = Signal(str)
    error = Signal(str)

    def run(self) -> None:
        try:
            # Choose elevation method: none (if already root), pkexec, or sudo
            if os.geteuid() == 0:
                elev = []
            elif shutil.which("pkexec"):
                elev = ["pkexec"]
            else:
                elev = ["sudo"]

            # Run smartctl --scan to find devices
            proc = subprocess.run(
                elev + ["smartctl", "--scan"],
                capture_output=True,
                text=True,
            )
            if proc.returncode != 0 and not proc.stdout:
                # no useful output
                raise RuntimeError(proc.stderr.strip() or "smartctl --scan failed")

            drives: Set[str] = set()
            for line in proc.stdout.splitlines():
                parts = line.split()
                # smartctl --scan lines usually start with a device path like /dev/sda
                for p in parts:
                    if p.startswith("/dev/"):
                        drives.add(p)
                        break

            if not drives:
                raise RuntimeError("No block devices found by smartctl --scan")

            outputs = []
            for drive in sorted(drives):
                header = f"{'='*60}\n{drive}\n{'='*60}\n"
                cmd = elev + ["smartctl", "-a", drive]
                try:
                    r = subprocess.run(cmd, capture_output=True, text=True)
                    out = (r.stdout or "") + (r.stderr or "")
                except Exception as e:
                    out = f"Failed to run {' '.join(cmd)}: {e}"
                outputs.append(header + out)

            self.finished.emit("\n".join(outputs))

        except Exception as exc:
            self.error.emit(str(exc))


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("filesage")
        self.resize(800, 600)  # default window size

        # Periodic timer to keep Python signal handling responsive.
        self.timer = QTimer()
        self.timer.timeout.connect(lambda: None)
        self.timer.start(200)

        central = QWidget()
        layout = QVBoxLayout(central)

        tabs = QTabWidget()
        layout.addWidget(tabs, 3)

        # File INFO tab
        info_tab = QWidget()
        info_layout = QVBoxLayout(info_tab)
        self.scan_button = QPushButton("Scan Drive")
        self.scan_button.clicked.connect(self.on_scan_drive)
        info_layout.addWidget(self.scan_button)

        self.smartctl_result = QPlainTextEdit()
        self.smartctl_result.setReadOnly(True)
        self.smartctl_result.setVisible(False)
        info_layout.addWidget(self.smartctl_result)

        info_layout.addStretch()
        tabs.addTab(info_tab, "File INFO")

        # File MANIPULATION tab
        manip_tab = QWidget()
        manip_layout = QVBoxLayout(manip_tab)
        manip_layout.addWidget(QLabel("File MANIPULATION"))
        tabs.addTab(manip_tab, "File MANIPULATION")

        # Log / status area
        self.log_view = QPlainTextEdit()
        self.log_view.setReadOnly(True)
        self.log_view.setPlaceholderText("Status and log messages...")
        layout.addWidget(self.log_view, 1)

        self.setCentralWidget(central)

        # Setup CTRL+C handler (must be set from the main thread)
        signal.signal(signal.SIGINT, self._handle_sigint)

        self.worker: SmartctlWorker | None = None

    def on_scan_drive(self) -> None:
        self.log("Starting elevated smartctl scan...")
        self.scan_button.setEnabled(False)

        self.worker = SmartctlWorker()
        self.worker.finished.connect(self.on_scan_complete)
        self.worker.error.connect(self.on_scan_error)
        self.worker.start()

    def on_scan_complete(self, output: str) -> None:
        self.scan_button.setVisible(False)
        self.smartctl_result.setPlainText(output)
        self.smartctl_result.setVisible(True)
        self.log("Drive scan completed.")
        self.worker = None

    def on_scan_error(self, error: str) -> None:
        self.log(f"Scan error: {error}")
        self.scan_button.setEnabled(True)
        self.worker = None

    def log(self, message: str) -> None:
        self.log_view.appendPlainText(message)

    def _handle_sigint(self, signum, frame) -> None:
        self.log("Interrupt signal received. Exiting...")
        QCoreApplication.quit()

    def showEvent(self, event):
        super().showEvent(event)
        screen = self.screen() or QGuiApplication.primaryScreen()
        if screen:
            center = screen.availableGeometry().center()
            frame = self.frameGeometry()
            frame.moveCenter(center)
            self.move(frame.topLeft())

