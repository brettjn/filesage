# file: filesage/main_window.py
import signal
import subprocess
from PySide6.QtWidgets import QMainWindow, QTabWidget, QWidget, QVBoxLayout, QLabel, QPlainTextEdit, QPushButton
from PySide6.QtGui import QGuiApplication
from PySide6.QtCore import QTimer
from PySide6.QtCore import QThread
from PySide6.QtCore import Signal
from PySide6.QtCore import QObject
from PySide6.QtCore import Slot


class SmartctlWorker(QObject):
    """Worker thread to run smartctl commands without blocking UI."""
    finished = Signal()
    progress = Signal(int)

    @Slot()
    def run(self):
        try:
            # Get list of drives
            result = subprocess.run(
                ["sudo", "smartctl", "--scan"],
                capture_output=True,
                text=True,
                check=True
            )
            drives = [line.split()[0] for line in result.stdout.strip().split('\n') if line.startswith('/')]

            output = []
            for drive in drives:
                result = subprocess.run(
                    ["sudo", "smartctl", "-a", drive],
                    capture_output=True,
                    text=True
                )
                output.append(f"{'=' * 60}\n{drive}\n{'=' * 60}\n{result.stdout}\n")

            self.finished.emit('\n'.join(output))
        except subprocess.CalledProcessError as e:
            #self.error.emit(f"Error running smartctl: {e.stderr}")
            self.log(f"Error running smartctl: {e.stderr}")
        except Exception as e:
            self.error.emit(f"Error: {str(e)}")


class MainWindow(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("filesage")
        self.resize(800, 600)

        central = QWidget()
        layout = QVBoxLayout(central)

        tabs = QTabWidget()
        layout.addWidget(tabs, 3)

        # File INFO tab
        info_tab = QWidget()
        info_layout = QVBoxLayout(info_tab)
        self.scan_button = QPushButton("Scan Drive")
        self.scan_button.clicked.connect(self.on_scan_drive)
        info_layout.addWidget(self.scan_button)

        self.smartctl_result = QPlainTextEdit()
        self.smartctl_result.setReadOnly(True)
        self.smartctl_result.setVisible(False)
        info_layout.addWidget(self.smartctl_result)

        info_layout.addStretch()
        tabs.addTab(info_tab, "File INFO")

        # File MANIPULATION tab
        manip_tab = QWidget()
        manip_layout = QVBoxLayout(manip_tab)
        manip_layout.addWidget(QLabel("File MANIPULATION"))
        tabs.addTab(manip_tab, "File MANIPULATION")

        # Log / status area
        self.log_view = QPlainTextEdit()
        self.log_view.setReadOnly(True)
        self.log_view.setPlaceholderText("Status and log messages...")
        layout.addWidget(self.log_view, 1)

        self.setCentralWidget(central)
        signal.signal(signal.SIGINT, self._handle_sigint)

    def on_scan_drive(self) -> None:
        """Handle scan drive button click."""
        self.log("Starting drive scan...")
        self.scan_button.setEnabled(False)

        self.worker = SmartctlWorker()
        self.worker.finished.connect(self.on_scan_complete)
        #self.worker.error.connect(self.on_scan_error)
        self.worker.run()

    def on_scan_complete(self, output: str) -> None:
        """Handle successful scan completion."""
        self.scan_button.setVisible(False)
        self.smartctl_result.setPlainText(output)
        self.smartctl_result.setVisible(True)
        self.log("Drive scan completed.")

    def on_scan_error(self, error: str) -> None:
        """Handle scan error."""
        self.log(f"Scan error: {error}")
        self.scan_button.setEnabled(True)

    def log(self, message: str) -> None:
        """Append a line to the log view."""
        self.log_view.appendPlainText(message)

    def _handle_sigint(self, signum, frame) -> None:
        """Handle CTRL+C signal."""
        self.log("Interrupt signal received. Exiting...")
        self.close()

    def showEvent(self, event):
        super().showEvent(event)
        screen = self.screen() or QGuiApplication.primaryScreen()
        if screen:
            center = screen.availableGeometry().center()
            frame = self.frameGeometry()
            frame.moveCenter(center)
            self.move(frame.topLeft())

